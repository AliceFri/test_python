
**Mysql 的架构 共分为两层： Server层 和 存储引擎层**

    Server层 负责建立连接, 分析和执行SQL
        大多数的核心模块， 连接器，查询缓存，解析器，预处理器，优化器，执行器。
        所有的内置函数
        所有跨存储引擎的功能，存储过程，触发器，视图等。

    存储引擎层负责数据的存储和提取
        Innodb MyISAM Memory等多个存储引擎。
        负责数据的存储和提取


### step1. 连接器

    mysql -h$ip -u$user -p

    mysql 基于tcp协议进行传输

##### 1. 如何查看MySQL服务被多少个客户端连接了

    show processlist

    mysql 定义了空闲连接的最大空闲时长， wait_timeout (show variables like 'wait_timeout')
    默认值为8小时

    kill connection +id; 手动断开空闲的连接

##### 2. MySQL的连接数有限制吗

    max_connections, 

##### 3. 怎么解决长连接占用内存的问题
    MySQL 在执行查询过程中临时使用内存管理连接对象，这些连接对象资源只有在连接断开时才会释放。所以长连接会占用较大的内存。
    1. 定期断开长连接
    2. 客户端主动重置连接

----------------------------------------------------

### step2 查询缓存

    这个查询缓存是以 key-value 形式保存在内存中的，key 为 SQL 查询语句，value 为 SQL 语句查询的结果。

    对于更新比较频繁的表，查询缓存的命中率很低的，因为只要一个表有更新操作，那么这个表的查询缓存就会被清空。

    MySQL 8.0 版本直接将查询缓存删掉了，也就是说 MySQL 8.0 开始，执行一条 SQL 查询语句，不会再走到查询缓存这个阶段了。

----------------------------------------------------

### step3 解析SQL

    在正式执行 SQL 查询语句之前， MySQL 会先对 SQL 语句做解析，这个工作交由「解析器」来完成。

    词法分析： 构建SQL语法树

    语法分析： 判断满不满足SQL语法

-----------------------------------------------------

### step4 执行SQL

#### 4.1 预处理器 prepare

    1. 检查SQL查询语句中的表或者字段是否存在
    2. 将 select * 中的*符号扩展为表上的所有列

#### 4.2 优化器 optimize
    主要负责将SQL查询语句的执行方案确定下来。 explain 语句（key）。
    

#### 4.3 执行器 execute
    在执行的过程中，执行器就会和存储引擎交互了，交互是以记录为单位的。

    主键索引查询

    全表扫描

    索引下推
        能够减少二级索引在查询时的回表操作，提高查询的效率，因为它将 Server 层部分负责的事情，交给存储引擎层去处理了。


### 执行一条 SQL 查询语句，期间发生了什么？

    连接器：建立连接，管理连接、校验用户身份；
    查询缓存：查询语句如果命中查询缓存则直接返回，否则继续往下执行。MySQL 8.0 已删除该模块；
    解析 SQL，通过解析器对 SQL 查询语句进行词法分析、语法分析，然后构建语法树，方便后续模块读取表名、字段、语句类型；
    执行 SQL：执行 SQL 共有三个阶段：
        预处理阶段：检查表或字段是否存在；将 select * 中的 * 符号扩展为表上的所有列。
        优化阶段：基于查询成本的考虑， 选择查询成本最小的执行计划；
        执行阶段：根据执行计划执行 SQL 查询语句，从存储引擎读取记录，返回给客户端；
